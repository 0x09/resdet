libresdet is a library for analyzing potential original resolutions in an image.

# Table of Contents

* [Example](#example)
* [Types](#types)
  * [RDError](#rderror)
  * [RDErrors](#rderrors)
  * [RDResolution](#rdresolution)
  * [RDMethod](#rdmethod)
  * [RDAnalysis](#rdanalysis)
  * [RDImage](#rdimage)
* [Functions](#functions)
  * [Utility Functions](#utility-functions)
    * [resdet_error_str](#resdet_error_str)
    * [resdet_get_max_error](#resdet_get_max_error)
    * [resdet_libversion](#resdet_libversion)
    * [resdet_methods](#resdet_methods)
    * [resdet_get_method](#resdet_get_method)
    * [resdet_alloc_default_parameters](#resdet_alloc_default_parameters)
    * [resdet_parameters_set_range](#resdet_parameters_set_range)
    * [resdet_parameters_set_threshold](#resdet_parameters_set_threshold)
    * [resdet_default_range](#resdet_default_range)
  * [Image Reading](#image-reading)
    * [resdet_open_image](#resdet_open_image)
    * [resdet_read_image_frame](#resdet_read_image_frame)
    * [resdet_seek_frame](#resdet_seek_frame)
    * [resdet_close_image](#resdet_close_image)
    * [resdet_read_image](#resdet_read_image)
    * [resdet_list_image_readers](#resdet_list_image_readers)
  * [Sequential Analysis](#sequential-analysis)
    * [resdet_create_analysis](#resdet_create_analysis)
    * [resdet_analyze_image](#resdet_analyze_image)
    * [resdet_analysis_results](#resdet_analysis_results)
    * [resdet_destroy_analysis](#resdet_destroy_analysis)
  * [High Level Detection Functions](#high-level-detection-functions)
    * [resdetect](#resdetect)
    * [resdetect_file](#resdetect_file)
* [Configuration Macros](#configuration-macros)
  * [PIXEL_MAX](#pixel_max)
  * [DEFAULT_RANGE](#default_range)
  * [COEFF_PRECISION](#coeff_precision)
  * [INTER_PRECISION](#inter_precision)
  * [VERSION_SUFFIX](#version_suffix)
  * [USE_BUILTIN_SIGNBIT](#use_builtin_signbit)
  * [HAVE_x](#have_x)
  * [OMIT_x_READER](#omit_x_reader)
* [Thread Safety](#thread-safety)

# Example

Detect potential resolutions in a file, using the defaults:

```C
const char *filename = ...;
	
RDResolution *widths, *heights;
size_t num_widths, num_heights;

RDError e = resdetect_file(filename, NULL, &widths, &num_widths, &heights, &num_heights, NULL, NULL);

if(e)
    // handle error

puts("Widths:")
for(size_t i = 0; i < num_widths; i++)
    printf("%zu\n", widths[i].index);

puts("Heights:")
for(size_t i = 0; i < num_heights; i++)
    printf("%zu\n", heights[i].index);

```

# Types
<a name="rderror"></a>

`RDError`

Integer type containing a value from the `RDErrors` enum or negative errno code.

---
<a name="rderrors"></a>

`enum RDErrors`

Enum of possible errors generated by the library.

The success value `RDEOK` is defined to be 0. All other error codes are nonzero.

Note that the maximum value of this enum may change and should not be relied on as part of the API. Instead use [`resdet_get_max_error`](#resdet_get_max_error).

---
<a name="rdresolution"></a>

`RDResolution`

Struct type representing detection results and returned in an array for each dimension from the resdetect_\* and [`resdet_analysis_results`](#resdet_analysis_results) functions.

|Member|Type|Description|
|---|---|---|
|index|`size_t`|Detected width or height value.|
|confidence|`float`| Confidence value in the range 0-1, with higher values representing higher certainty.|

---
<a name="rdmethod"></a>

`RDMethod`

Const struct type encapsulating an upscaling detection method.

|Member|Type|Description|
|---|---|---|
|name|`const char*`|Method name.|
|func|`void (*)(void)`|Opaque pointer to the method's implementation.|
|threshold|`float`|Appropriate default threshold for this method's detection results.|

---
<a name="rdparameters"></a>

`RDParameters`

Opaque type containing optional parameters for controlling detection behavior, used in [`resdet_create_analysis`](#resdet_create_anlysis) and the [high level detection functions](#high-level-detection-functions).

---
<a name="rdanalysis"></a>

`RDAnalysis`

Opaque type used for [sequential analysis](#sequential-analysis).

---
<a name="rdimage"></a>

`RDImage`

Opaque type representing an open image handle, used by the [image reading](#image-reading) functions.

---

# Functions

## Utility Functions

<a name="resdet_error_str"></a>

```C
const char* resdet_error_str(RDError);
```

resdet library functions return an [`RDError`](#rderror) to indicate any failure. Use `resdet_error_str(error)` to map an [`RDError`](#rderror) to a descriptive string. The returned value is statically allocated and does not need to be freed. Returns `NULL` if the provided error does not map to a valid `RDError`.

* error - An [`RDError`](#rderror) error code returned by the library.

This function may call `strerror` internally which may not be thread safe on your platform.

---
<a name="resdet_get_max_error"></a>

```C
enum RDErrors resdet_get_max_error(void);
```

Returns the current maximum value of the [RDErrors](#rderrors) enum. May be used to safely obtain this rather than referencing the largest [RDErrors](#rderrors) enum value directly.

---
<a name="resdet_libversion"></a>

```C
const char* resdet_libversion(void);
```

Returns the resdet library version as a string.

---
<a name="resdet_methods"></a>

```C
RDMethod* resdet_methods(void);
```

Returns list of available methods, terminated by an empty [`RDMethod`](#rdmethod). The first element can be assumed to be the library default. Can be iterated using

```C
for(RDMethod* m = resdet_methods(); m->name; m++)
	...;
```

---
<a name="resdet_get_method"></a>

```C
RDMethod* resdet_get_method(const char* name);
```

Lookup a method by name.

* name - The name of a method, or `NULL` for the default method.

Returns a pointer to an [`RDMethod`](#rdmethod) or `NULL` if no name matches.

---
<a name="resdet_alloc_default_parameters"></a>

```C
RDParameters* resdet_alloc_default_parameters(void);
```
Obtain an allocated [`RDParameters`](#rdparameters) containing default values. Values may be updated with the `resdet_parameters_set_*` functions.
Must be freed by the caller.

Returns `NULL` if the system is out of memory. 

---

<a name="resdet_parameters_set_range"></a>

```C
RDError resdet_parameters_set_range(RDParameters* params, size_t range);
```
Set the range of coefficients to consider when looking for inversions. Lower values are faster, but may return many more misidentified results. Reasonable values are between 8 and 32. The library default can be obtained by calling [`resdet_default_range`](#resdet_default_range).
This function returns an `RDEPARAM` error if the value is zero.

* params - An [`RDParameters`](#rdparameters) returned from [`resdet_alloc_default_parameters`](#resdet_alloc_default_parameters).
* range - The range value.

---
<a name="resdet_parameters_set_threshold"></a>

```C
RDError resdet_parameters_set_threshold(RDParameters* params, float threshold);
```
Set the method-specific value under which detected resolutions won't be considered meaningful. A value of 0 will return an [`RDResolution`](#rdresolution) result for every single line/column. The method-specific default can be obtained from ([`RDMethod->threshold`](#rdmethod)).
This function returns an `RDEPARAM` error for values below zero or `NaN`.

* params - An [`RDParameters`](#rdparameters) returned from [`resdet_alloc_default_parameters`](#resdet_alloc_default_parameters).
* threshold - A threshold value between 0 and 1.

---
<a name="resdet_default_range"></a>

```C
size_t resdet_default_range(void);
```

Returns the library default search range, as used when not explicitly specifying the range via [`RDParameters`](#rdparameters).

Most detection methods use this value to determine how many neighboring values to consider when detecting a given resolution.

Higher values are more accurate up to a point, while lower values are faster.

## Image Reading

Functions for reading image data using the library's built-in image readers.

---
<a name="resdet_open_image"></a>

```C
RDImage* resdet_open_image(const char* filename, const char* filetype, size_t* width, size_t* height, float** imagebuf, RDError* error);
```

Open an image for reading with [`resdet_read_image_frame`](#resdet_read_image_frame).
The returned RDImage pointer should be passed to [`resdet_close_image`](#resdet_close_image) when finished.
If an error occurs the returned pointer will be `NULL` and the error pointer updated to indicate what went wrong. 

* filename - Path of the image, or "-" for standard input.
* filetype - Optional type of the image for choosing an image reader. May be either an extension or MIME type. If `NULL` the file's extension will be used.
* width, height - Out parameters containing the bitmap dimensions.
* imagebuf - If not `NULL`, on output points to an allocated buffer large enough to pass to [`resdet_read_image_frame`](#resdet_read_image_frame), or `NULL` on error. Its contents are uninitialized. Must be freed by the caller.
* error - Out parameter containing the error if any, or `RDEOK`.

---
<a name="resdet_read_image_frame"></a>

```C
bool resdet_read_image_frame(RDImage* rdimage, float* image, RDError* error);
```

Read one frame of an image or image sequence. Returns false if there are no more images left in the sequence or on error, true otherwise.

After reading the image data, this function advances the [`RDImage`](#rdimage) to the next frame, so successive calls return successive frames in an image sequence.

`resdet_read_image_frame` should not be called from parallel threads with the same [`RDImage`](#rdimage).

* rdimage - An [`RDImage`](#rdimage) pointer obtained from [`resdet_open_image`](resdet_open_image).
* image - Buffer at least width x height large where the image data is written. Image data is grayscale and normalized to a range of 0-1.
* error - Out parameter containing the error if any, or `RDEOK`.

---
<a name="resdet_seek_frame"></a>

```C
bool resdet_seek_frame(RDImage* rdimage, uint64_t offset, void(*progress)(void* ctx,uint64_t frameno), void* progress_ctx, RDError* error);
```

Seeks `offset` frames in an image sequence. The next call to [`resdet_read_image_frame`](#resdet_read_image_frame) will begin at this offset. Returns false if there are no more images left in the sequence or on error, true otherwise.

`resdet_seek_image_frame` should not be called from parallel threads with the same [`RDImage`](#rdimage).

* rdimage - An [`RDImage`](#rdimage) pointer obtained from [`resdet_open_image`](resdet_open_image).
* offset - The offset in frames to seek.
* progress - Optional pointer to a function which will be called with `progress_ctx` and the frame index as seeking progresses.
* progress_ctx - Optional context for the `progress` callback.
* error - Out parameter containing the error if any, or `RDEOK`.

---
<a name="resdet_close_image"></a>

```C
void resdet_close_image(RDImage* rdimage);
```

Close an image and free its resources.

* rdimage - An [`RDImage`](#rdimage) returned from [`resdet_open_image`](resdet_open_image). May be `NULL`.

---
<a name="resdet_read_image"></a>

```C
RDError resdet_read_image(const char* filename, const char* filetype, float** image, size_t* nimages, size_t* width, size_t* height);
```

Read an image or image sequence in bulk using the library's built-in image readers.
This function is a wrapper for [`resdet_open_image`](#resdet_open_image), [`resdet_read_image_frame`](#resdet_read_image_frame), and [`resdet_close_image`](#resdet_close_image).

Note that this function is not recommended for multiple frame sequences over the iterative API above due to the potentially high memory requirements of loading frames in bulk.

* filename - Path of the image, or "-" for standard input.
* filetype - Optional type of the image for choosing an image reader. May be either an extension or MIME type. If `NULL` the file's extension will be used.
* image - Out parameter containing the floating point grayscale image data, normalized to a range of 0-1. Multiple images (i.e. y4m, gif) are simply contiguous such that image 2 begins at the address of `image + width * height`. Allocated by the library, must be freed by caller.
* nimages - Out parameter containing the number of images returned.
* width, height - Out parameters containing the bitmap dimensions.

---
<a name="resdet_list_image_readers"></a>

```C
const char* const* resdet_list_image_readers(void);
```

Obtain an array of names of the image readers that were built with the library. The list is terminated by a `NULL` pointer.

## Sequential Analysis

Functions for analyzing an image or iterative sequence of images.

---
<a name="resdet_create_analysis"></a>

```C
RDAnalysis* resdet_create_analysis(RDMethod* method, size_t width, size_t height, const RDParameters* params, RDError* error);
```

Start a sequential analysis.  
The returned [`RDAnalysis`](#rdanalysis) pointer should be passed to [`resdet_destroy_analysis`](#resdet_destroy_analysis) when finished.  
If an error occurs the returned pointer will be `NULL` and the error pointer updated to indicate what went wrong. 

* method - A detection method returned by [`resdet_methods`](#resdet_methods) or [`resdet_get_method`](#resdet_get_method). May be `NULL` to use the library default method.
* width, height - Dimensions of the image which will be passed to [`resdet_analyze_image`](#resdet_analyze_image).
* params - Optional pointer to an [`RDParameters`](#rdparameters) struct for controlling detection behavior, or `NULL` to use the library default parameters.
* error - Out parameter containing the error if any, or `RDEOK`.

---
<a name="resdet_analyze_image"></a>

```C
RDError resdet_analyze_image(RDAnalysis* analysis, float* image);
```
Analyze a single image. Call multiple times with the same [`RDAnalysis`](#rdanalysis) to include multiple frames of an image sequence in the analysis. 

This function should not be called from parallel threads with the same [`RDAnalysis`](#rdanalysis).

* analysis - An [`RDAnalysis`](#rdanalysis) returned from the [`resdet_create_analysis`](#resdet_create_analysis) functions.
* image - The floating point grayscale image data.

---
<a name="resdet_analysis_results"></a>

```C
RDError resdet_analysis_results(RDAnalysis*,
                                RDResolution** restrict resw, size_t* restrict countw,
                                RDResolution** restrict resh, size_t* restrict counth);
```

Get the detection results from an analysis.  
Typically called after all images in a sequence have been analyzed with [`resdet_analyze_image`](#resdet_analyze_image). May be called multiple times with the same [`RDAnalysis`](#rdanalysis) to re-obtain results or before all images are analyzed to obtain preliminary results, however [`resdet_analyze_image`](#resdet_analyze_image) must have been called with this [`RDAnalysis`](#rdanalysis) at least once before collecting results.

* resw, resh - Output [`RDResolution`](#rdresolution) arrays of pixel index and confidence pairs describing a potential detected resolution. Results are sorted in descending order of confidence. The original input resolution is always available as the final element with a confidence value of -1. Either may be `NULL` to skip gathering results for that dimension. If provided, respective count param must point to valid size_t memory. Guaranteed to be either allocated or nulled by the library, must be freed by caller.
* countw, counth - Size of resw and resh respectively.

---
<a name="resdet_destroy_analysis"></a>

```C
void resdet_destroy_analysis(RDAnalysis* analysis);
```

Destroy an analysis. Should match all calls to the [`resdet_create_analysis`](#resdet_create_analysis) functions.

* analysis - An [`RDAnalysis`](#rdanalysis) returned from the [`resdet_create_analysis`](#resdet_create_analysis) functions. May be `NULL`.

## High Level Detection Functions

These functions wrap the above  [image reading](#image-reading) and [sequential analysis](#sequential-analysis) APIs.

---
<a name="resdetect_file"></a>

```C
RDError resdetect_file(const char* filename, const char* filetype,
                       RDResolution** restrict resw, size_t* restrict countw,
                       RDResolution** restrict resh, size_t* restrict counth,
                       RDMethod* method, const RDParameters* params);
```

* filename - Path of the image, or "-" for standard input.
* filetype - Optional type of the image for choosing an image reader. May be either an extension or MIME type. If `NULL` the file's extension will be used.
* resw, resh - Output [`RDResolution`](#rdresolution) arrays of pixel index and confidence pairs describing a potential detected resolution. Results are sorted in descending order of confidence. The original input resolution is always available as the final element with a confidence value of -1. Either may be `NULL` to skip gathering results for that dimension. If provided, respective count param must point to valid size_t memory. Guaranteed to be either allocated or nulled by the library, must be freed by caller.
* countw, counth - Size of resw and resh respectively.
* method - A detection method returned by [`resdet_methods`](#resdet_methods) or [`resdet_get_method`](#resdet_get_method). May be `NULL` to use the library default method.
* params - Optional pointer to an [`RDParameters`](#rdparameters) struct for controlling detection behavior, or `NULL` to use the library default parameters.

---
<a name="resdetect"></a>

```C
RDError resdetect(float* image, size_t nimages, size_t width, size_t height,
                  RDResolution** restrict resw, size_t* restrict countw,
                  RDResolution** restrict resh, size_t* restrict counth,
                  RDMethod* method, const RDParameters* params);
```

Detect from a bitmap or series of bitmaps directly.

* image - floating point grayscale image data.
* nimages - Number of contiguous images in the buffer. Must be at least 1.
* width, height - Dimensions of the bitmap.
* resw, resh - Output [`RDResolution`](#rdresolution) arrays of pixel index and confidence pairs describing a potential detected resolution. Results are sorted in descending order of confidence. The original input resolution is always available as the final element with a confidence value of -1. Either may be `NULL` to skip gathering results for that dimension. If provided, respective count param must point to valid size_t memory. Guaranteed to be either allocated or nulled by the library, must be freed by caller.
* countw, counth - Size of resw and resh respectively.
* method - A detection method returned by [`resdet_methods`](#resdet_methods) or [`resdet_get_method`](#resdet_get_method). May be `NULL` to use the library default method.
* params - Optional pointer to an [`RDParameters`](#rdparameters) struct for controlling detection behavior, or `NULL` to use the library default parameters.

# Configuration Macros
Macros that may be defined when building libresdet which affect the behavior of the library.

When using the provided build scripts, these are either exposed as arguments to `configure` or automatically detected as appropriate.

Note: outside of their use during compilation of the library itself, these macros are not exposed by libresdet. 

---
<a name="pixel_max"></a>

`PIXEL_MAX`

Limits the maximum size of images processed by the library as a product of the dimensions. Larger images result in an `RDETOOBIG` error. May be used to indirectly limit memory use.

Default: `SIZE_MAX`

---
<a name="default_range"></a>

`DEFAULT_RANGE`

The default range used in detection methods and returned by [`resdet_default_range`](#resdet_default_range). Reasonable values are between 8 and 32. A different value for this may be provided at runtime by passing  [`RDParameters`](#rdparameters) to the detection methods.

Default: `12`

---
<a name="coeff_precision"></a>

`COEFF_PRECISION`

Floating point precision used by the library for DCT transforms and coefficient buffers. May be defined to `F`, `D`, or `L` for float, double, or long double precision respectively.

Default: `F`

Note that this value impacts the FFT libraries used by resdet in the following ways:
* When building with FFTW, affects the version of the FFTW library that should be linked (`libfftw3f`, `libfftw3`, or `libfftw3l` respectively).
* When building with KISS FFT and a precision greater than `F`, the `kiss_fft_scalar` macro should be defined to `double` while building libresdet and the embedded KISS FFT subtree.

These are handled automatically when building libresdet using the provided build scripts and using the libresdet pkg-config file.

---
<a name="inter_precision"></a>

`INTER_PRECISION`

Floating point precision used by the library for intermediate floating point calculations. May be defined to `F`, `D`, or `L` for float, double, or long double precision respectively. Must be at least as precise or more precise than [`COEFF_PRECISION`](#coeff_precision).  
Unlike [`COEFF_PRECISION`](#coeff_precision) this has no extra implications for the FFT libraries.

Default: `D`

---
<a name="version_suffix"></a>

`VERSION_SUFFIX`

Append a string to the version returned by [`resdet_libversion`](#resdet_libversion). resdet's build script uses this to append the git revision in non-release builds. Custom builds may use this to append metadata if desired.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="use_builtin_signbit"></a>

`USE_BUILTIN_SIGNBIT`

Use the compiler's `__builtin_signbit` implementation in calculations instead of the libc `signbit`. When configured with the provided build scripts this is enabled automatically if the compiler supports it.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="have_x"></a>

`HAVE_x`

Where `x` is one of the optional external libraries used by resdet for image reading. Currently this includes `LIBJPEG`, `LIBPNG`, `MAGICKWAND`, and `FFMPEG`.  
Should be defined if resdet will be built with the corresponding image reader and external library.  

For `HAVE_MAGICKWAND`, the value should be the specific library version (e.g. 6 or 7) as this affects the header location. Otherwise no value is needed.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="omit_x_reader"></a>

`OMIT_x_READER`

Used to omit building of one of resdet's built-in image readers. Currently this includes `PGM`, `PFM`, and `Y4M`.
This may be desired to have another image reader like MagickWand or FFmpeg handle these file types or if no native image reading functionality is needed.

Default: conditionally defined by the build script. Not defined otherwise.

# Thread Safety
libresdet's own routines are thread safe except where explicitly noted, but some of its optional supporting libraries rely on global state. As libresdet does not mandate a threading model itself, it cannot enforce their safe execution in a multithreaded app.  
If your application will make calls to resdet from concurrent threads while one of these are enabled, your application must independently prepare these libraries for threaded use at the start of execution.

These measures are only necessary when both:

1. resdet is built with either FFTW or ImageMagick support, and
2. resdet routines will be called concurrently.

In all other cases no extra preparation is needed.

Steps to prepare each of these for threaded execution are:

* FFTW
 * Include `fftw.h`
 * Call [`fftw_make_planner_thread_safe()`](http://www.fftw.org/fftw3_doc/Thread-safety.html#Thread-safety)
 * Link with a threaded version of the FFTW library
 * Link with the system's threading library if necessary
* MagickWand
 * Include `MagickWand.h`
 * Call [`MagickWandGenesis()`](https://www.imagemagick.org/api/magick-wand.php#MagickWandGenesis)
