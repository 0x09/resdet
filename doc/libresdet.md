libresdet is a small library for analyzing potential original resolutions in an image.

# Table of Contents

* [Example](#example)
* [Types](#types)
  * [RDError](#rderror)
  * [RDErrors](#rderrors)
  * [RDResolution](#rdresolution)
  * [RDMethod](#rdmethod)
* [Functions](#functions)
  * [Utility Functions](#utility-functions)
    * [resdet_error_str](#resdet_error_str)
    * [resdet_libversion](#resdet_libversion)
    * [resdet_methods](#resdet_methods)
    * [resdet_get_method](#resdet_get_method)
    * [resdet_default_range](#resdet_default_range)
  * [Image Reading](#image-reading) 
    * [resdet_read_image](#resdet_read_image)
  * [Detection Functions](#detection-functions) 
    * [resdetect_file](#resdetect_file)
    * [resdetect_file_with_params](#resdetect_file_with_params)
    * [resdetect](#resdetect)
    * [resdetect_with_params](#resdetect_with_params)
* [Configuration Macros](#configuration-macros)
  * [PIXEL_MAX](#pixel_max)
  * [DEFAULT_RANGE](#default_range)
  * [COEFF_PRECISION](#coeff_precision)
  * [INTER_PRECISION](#inter_precision)
  * [VERSION_SUFFIX](#version_suffix)
  * [USE_BUILTIN_SIGNBIT](#use_builtin_signbit)
  * [HAVE_x](#have_x)
  * [OMIT_NATIVE_PGM_READER](#omit_native_pgm_reader)
* [Thread Safety](#thread-safety)

# Example

Detect potential resolutions in a file, using the defaults:

```C
const char *filename = ...;
	
RDResolution *widths, *heights;
size_t num_widths, num_heights;

RDError e = resdetect_file(filename, NULL, &widths, &num_widths, &heights, &num_heights, NULL);

if(e)
    // handle error

puts("Widths:")
for(size_t i = 0; i < num_widths; i++)
    printf("%zu\n", widths[i].index);

puts("Heights:")
for(size_t i = 0; i < num_heights; i++)
    printf("%zu\n", heights[i].index);

```

# Types
<a name="rderror"></a>

`RDError`

Integer type containing a value from the `RDErrors` enum or negative errno code.

---
<a name="rderrors"></a>

`enum RDErrors`

Enum of possible errors generated by the library.

The success value `RDEOK` is defined to be 0. All other error codes are nonzero. 

---
<a name="rdresolution"></a>

`RDResolution`

Struct type representing detection results and returned in an array for each dimension from the resdetect_\* functions.

|Member|Type|Description|
|---|---|---|
|index|`size_t`|Detected width or height value.|
|confidence|`float`| Confidence value in the range 0-1, with higher values representing higher certainty.|

---
<a name="rdmethod"></a>

`RDMethod`

Const struct type encapsulating an upscaling detection method.

|Member|Type|Description|
|---|---|---|
|name|`const char*`|Method name.|
|func|`void (*)(void)`|Opaque pointer to the method's implementation.|
|threshold|`float`|Appropriate default threshold for this method's detection results.|


# Functions

## Utility Functions

<a name="resdet_error_str"></a>

```C
const char* resdet_error_str(RDError);
```

Most library functions return [`RDError`](#rderror) to indicate any failure. Use `resdet_error_str(error)` to map an [`RDError`](#rderror) to a descriptive string. The returned value is statically allocated and does not need to be freed. Returns NULL if the provided error does not map to a valid RDError.

---
<a name="resdet_libversion"></a>

```C
const char* resdet_libversion(void);
```

Returns the resdet library version as a string.

---
<a name="resdet_methods"></a>

```C
RDMethod* resdet_methods(void);
```

Returns list of available methods, terminated by an empty [RDMethod](#rdmethod). The first element can be assumed to be the library default. Can be iterated using

```C
for(RDMethod* m = resdet_methods(); m->name; m++)
	...;
```

---
<a name="resdet_get_method"></a>

```C
RDMethod* resdet_get_method(const char* name);
```

Lookup a method by name.

* name - The name of a method, or NULL for the default method.

Returns an [RDMethod](#rdmethod) or NULL if no name matches.

---
<a name="resdet_default_range"></a>

```C
size_t resdet_default_range(void);
```

Returns the library default search range, as used when not explicitly specifying the range via the [`redetect_with_params`](#resdetect_with_params).

Most detection methods use this value to determine how many neighboring values to consider when detecting a given resolution.

Higher values are more accurate up to a point, while lower values are faster.

## Image Reading

---
<a name="resdet_read_image"></a>

```C
RDError resdet_read_image(const char* filename, const char* mimetype, float** image, size_t* nimages, size_t* width, size_t* height);
```

Read an image using whatever image loaders the library was built with.

* filename - Path of the image, or "-" for standard input.
* mimetype - Optional MIME type of the image, for choosing an image reader. If NULL the file's extension will be used.
* image - Out parameter containing the floating point grayscale image data, normalized to a range of 0-1. Multiple images (i.e. y4m, gif) are simply contiguous such that image 2 begins at the address of image + width * height. Allocated by the library, must be freed by caller.
* nimages - Out parameter containing the number of images returned.

## Detection Functions

---
<a name="resdetect_file"></a>

```C
RDError resdetect_file(const char* filename, RDResolution** resw, size_t* countw, RDResolution** resh, size_t* counth, RDMethod* method);
```

* filename - Path of the image, or "-" for standard input.
* mimetype - Optional MIME type of the image, for choosing an image reader. If NULL the file's extension will be used.
* resw, resh - Output [RDResolution](#rdresolution) arrays of pixel index and confidence pairs describing a potential detected resolution. Results are sorted in descending order of confidence. The original input resolution is always available as the final element with a confidence value of -1. Either may be NULL to skip analyzing that dimension. If provided, respective count param must point to valid size_t memory. Guaranteed to be either allocated or nulled by the library, must be freed by caller.
* countw, counth - Size of resw and resh respectively.
* method - A detection method returned by [`resdet_methods`](#resdet_methods) or [`resdet_get_method`](#resdet_get_method). May be `NULL` to use the library default method.

---
<a name="resdetect_file_with_params"></a>

```C
RDError resdetect_file_with_params(const char* filename,
                                   RDResolution** resw, size_t* countw, RDResolution** resh, size_t* counth,
                                   RDMethod* method, size_t range, float threshold);
```

Detect with specified parameters.

This function takes the same arguments as [`resdetect_file`](#resdetect_file) plus the following:

* range - Range of coefficients to consider when looking for inversions. Lower values are faster, but may return many more misidentified results. The default is currently 12 ([DEFAULT_RANGE](#default_range)), with reasonable values between 8-32.
* threshold - Method-specific value (RDMethod->threshold) under which detected resolutions won't be considered meaningful. A value of 0 will return an RDResolution result for every single line/column.

* width, height - Out parameters containing the bitmap dimensions.

---
<a name="resdetect"></a>

```C
RDError resdetect(float* image, size_t nimages, size_t width, size_t height,
                   RDResolution** resw, size_t* countw, RDResolution** resh, size_t* counth,
                   RDMethod* method);
```

Detect from a bitmap or series of bitmaps directly.

* image - floating point grayscale image data.
* nimages - Number of contiguous images in the buffer. Must be at least 1.
* width, height - Dimensions of the bitmap.
* resw, resh - Output [RDResolution](#rdresolution) arrays of pixel index and confidence pairs describing a potential detected resolution. Results are sorted in descending order of confidence. The original input resolution is always available as the final element with a confidence value of -1. Either may be NULL to skip analyzing that dimension. If provided, respective count param must point to valid size_t memory. Guaranteed to be either allocated or nulled by the library, must be freed by caller.
* countw, counth - Size of resw and resh respectively.
* method - A detection method returned by [`resdet_methods`](#resdet_methods) or [`resdet_get_method`](#resdet_get_method). May be `NULL` to use the library default method.

---
<a name="resdetect_with_params"></a>

```C
RDError resdetect_with_params(float* image, size_t nimages, size_t width, size_t height,
                              RDResolution** resw, size_t* countw, RDResolution** resh, size_t* counth,
                              RDMethod* method, size_t range, float threshold);
```

Detect from a bitmap directly with specified parameters.

This function takes the same arguments as [`resdetect`](#resdetect) plus the following:

* range - Range of coefficients to consider when looking for inversions. Lower values are faster, but may return many more misidentified results. The default is currently 12 ([DEFAULT_RANGE](#default_range)), with reasonable values between 8-32.
* threshold - Method-specific value (RDMethod->threshold) under which detected resolutions won't be considered meaningful. A value of 0 will return an RDResolution result for every single line/column.

# Configuration Macros
Macros that may be defined when building libresdet which affect the behavior of the library.

When using the provided build scripts, these are either exposed as arguments to `configure` or automatically detected as appropriate.

Note: outside of their use during compilation of the library itself, these macros are not exposed by libresdet. 

---
<a name="pixel_max"></a>

`PIXEL_MAX`

Limits the maximum size of images processed by the library as a product of the dimensions. Larger images result in an `RDETOOBIG` error. May be used to indirectly limit memory use.

Default: `SIZE_MAX`

---
<a name="default_range"></a>

`DEFAULT_RANGE`

The default range used in detection methods and returned by [`resdet_default_range`](#resdet_default_range). Reasonable values are between 8 and 32. A different value for this may be provided at runtime with the `_with_params` resdet method variants.

Default: `12`

---
<a name="coeff_precision"></a>

`COEFF_PRECISION`

Floating point precision used by the library for DCT transforms and coefficient buffers. May be defined to `F`, `D`, or `L` for float, double, or long double precision respectively.

Default: `F`

Note that this value impacts the FFT libraries used by resdet in the following ways:
* When building with FFTW, affects the version of the FFTW library that should be linked (`libfftw3f`, `libfftw3`, or `libfftw3l` respectively).
* When building with KISS FFT and a precision greater than `F`, the `kiss_fft_scalar` macro should be defined to `double` while building libresdet and the embedded KISS FFT subtree.

These are handled automatically when building libresdet using the provided build scripts and using the libresdet pkg-config file.

---
<a name="inter_precision"></a>

`INTER_PRECISION`

Floating point precision used by the library for intermediate floating point calculations. May be defined to `F`, `D`, or `L` for float, double, or long double precision respectively. Must be at least as precise or more precise than [`COEFF_PRECISION`](#coeff_precision).  
Unlike [`COEFF_PRECISION`](#coeff_precision) this has no extra implications for the FFT libraries.

Default: `D`

---
<a name="version_suffix"></a>

`VERSION_SUFFIX`

Append a string to the version returned by [`resdet_libversion`](#resdet_libversion). resdet's build script uses this to append the git revision in non-release builds. Custom builds may use this to append metadata if desired.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="use_builtin_signbit"></a>

`USE_BUILTIN_SIGNBIT`

Use the compiler's `__builtin_signbit` implementation in calculations instead of the libc `signbit`. When configured with the provided build scripts this is enabled automatically if the compiler supports it.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="have_x"></a>

`HAVE_x`

Where `x` is one of the optional external libraries used by resdet for image reading. Currently this includes `LIBJPEG`, `LIBPNG`, `MJPEGTOOLS`, and `MAGICKWAND`.  
Should be defined if resdet will be built with the corresponding image reader and external library.  

For `HAVE_MAGICKWAND`, the value should be the specific library version (e.g. 6 or 7) as this affects the header location. Otherwise no value is needed.

Default: conditionally defined by the build script. Not defined otherwise.

---
<a name="omit_native_pgm_reader"></a>

`OMIT_NATIVE_PGM_READER`

Should be defined if the library's own PGM and PFM image readers (lib/image/pgm.c) will not be built. This may be desired to e.g. have the MagickWand reader handle these file types, or if no built-in image reading functionality is needed by the application.

Default: conditionally defined by the build script. Not defined otherwise.

# Thread Safety
libresdet's own routines are thread safe, but some of its optional supporting libraries rely on global state. As libresdet does not mandate a threading model itself, it cannot enforce their safe execution in a multithreaded app.  
If your application will make calls to resdet from concurrent threads while one of these are enabled, your application must independently prepare these libraries for threaded use at the start of execution.

These measures are only necessary when both:

1. resdet is built with either FFTW or ImageMagick support, and
2. resdet routines will be called concurrently.

In all other cases no extra preparation is needed.

Steps to prepare each of these for threaded execution are:

* FFTW
 * Include `fftw.h`
 * Call [`fftw_make_planner_thread_safe()`](http://www.fftw.org/fftw3_doc/Thread-safety.html#Thread-safety)
 * Link with a threaded version of the FFTW library
 * Link with the system's threading library if necessary
* MagickWand
 * Include `MagickWand.h`
 * Call [`MagickWandGenesis()`](https://www.imagemagick.org/api/magick-wand.php#MagickWandGenesis)
