name: build-and-test
on: [push]
jobs:
  build-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libpng-dev libjpeg-dev libmagickwand-6.q16-dev libfftw3-dev libavcodec-dev libavformat-dev libavutil-dev libswscale-dev curl gawk libcmocka-dev
      - name: Build and install resdet
        run: |
          ./configure
          make
          sudo make install
      - name: Run tests
        run: make check
      - name: Run resdet
        run: resdet -v0 test/files/blue_marble_2012_resized.pfm
  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v5
      - name: Install dependencies
        run: |
          brew update
          brew install fftw imagemagick ffmpeg gawk cmocka #libpng and libjpeg are already installed
      - name: Build and install resdet
        run: |
          ./configure
          make
          sudo make install
      - name: Run tests
        run: make check
      - name: Run resdet
        run: resdet -v0 test/files/blue_marble_2012_resized.pfm
  build-windows:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v5
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: git mingw-w64-ucrt-x86_64-gcc pkg-config make curl mingw-w64-ucrt-x86_64-libpng mingw-w64-ucrt-x86_64-libjpeg-turbo mingw-w64-ucrt-x86_64-imagemagick mingw-w64-ucrt-x86_64-ffmpeg gawk mingw-w64-ucrt-x86_64-cmocka
      - name: Build resdet
        run: |
          ./configure
          make
        env:
          TEST_LIBS: -lcmocka
      - name: Run tests
        run: make check
      - name: Run resdet
        run: ./resdet.exe -v0 test/files/blue_marble_2012_resized.pfm
